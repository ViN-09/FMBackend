<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Monitoring Dashboard</title>
  <link rel="stylesheet" href="src/Font-Awesome-6.4.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="src/node_modules/sweetalert2/dist/sweetalert2.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <link href="src/bootstrap-5.3.6-dist/bootstrap-5.3.6-dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="css/dashboard.css" />
  <link rel="stylesheet" href="css/sidebar.css" />
</head>
<body>  
  <header>
    <div class="menu-button"><i class="fas fa-bars" id="openSidebar"></i></div>
    <img src="asset/TelkomselLogo.png" alt="Telkomsel Logo" class="logo" />
  </header>

  <div id="overlay" class="overlay"></div>
  <div id="mySidebar" class="sidebar">
    <div class="sidebar-header">
      <img src="asset/telkom.png" alt="Telkomsel Logo" class="logo" />
    </div>
    <span class="closebtn" id="closeSidebar">&times;</span>
    <ul class="menu">
      <li id="data-tracking"><i class="fas fa-clipboard-list"></i> Data Tracking</li>
      <li id="monitoring"><i class="fas fa-clipboard-list"></i> Monitoring</li>
      <li id="alarm"><i class="fas fa-clipboard-list"></i> Alarm</li>
      <li id="log-out"><i class="fas fa-right-from-bracket"></i> Log Out</li>
    </ul>
  </div>

  <h1 id="page-title">MONITORING DASHBOARD</h1>

  <div class="dashboard">
    <div class="box">
      <h3>PUE</h3>
      <canvas id="sunburstChart"></canvas>
    </div>

    <div class="box">
      <h3>PUE</h3>
      <canvas id="lineChart"></canvas>
    </div>

    <div class="box temp-box">
      <div class="temp-item">
        <div class="info"><strong>Battery RAN</strong><br><span id="batt-ran-temp">25°C</span><br><small id="batt-ran-hum">H: 60%</small></div>
        <i class="fas fa-thermometer-half"></i>
      </div>
      <div class="temp-item">
        <div class="info"><strong>Battery Core</strong><br><span id="batt-core-temp">26°C</span><br><small id="batt-core-hum">H: 62%</small></div>
        <i class="fas fa-thermometer-half"></i>
      </div>

      <!-- NFVI, kasih id supaya bisa di-hide kalau site = teling -->
      <div class="temp-item" id="nfvi-temp-item">
        <div class="info"><strong>NFVI</strong><br><span id="nfvi-temp">28°C</span><br><small id="nfvi-hum">H: 58%</small></div>
        <i class="fas fa-thermometer-half"></i>
      </div>

      <div class="temp-item">
        <div class="info"><strong>RAN</strong><br><span id="ran-temp">30°C</span><br><small id="ran-hum">H: 55%</small></div>
        <i class="fas fa-thermometer-half"></i>
      </div>
      <div class="temp-item">
        <div class="info"><strong>Core</strong><br><span id="core-temp">27°C</span><br><small id="core-hum">H: 59%</small></div>
        <i class="fas fa-thermometer-half"></i>
      </div>
      <div class="temp-item">
        <div class="info"><strong>Interkoneksi</strong><br><span id="inter-temp">29°C</span><br><small id="inter-hum">H: 57%</small></div>
        <i class="fas fa-thermometer-half"></i>
      </div>
      <div class="temp-item">
        <div class="info"><strong>Trafo</strong><br><span id="trafo-temp">24°C</span><br><small id="trafo-hum">H: 63%</small></div>
        <i class="fas fa-thermometer-half"></i>
      </div>
      <div class="temp-item">
        <div class="info"><strong>Genset</strong><br><span id="genset-temp">24°C</span><br><small id="genset-hum">H: 63%</small></div>
        <i class="fas fa-thermometer-half"></i>
      </div>
  </div>

    <div class="box">
      <h3>LOAD TTC</h3>
      <canvas id="loadTTCChart"></canvas>
    </div>

    <div class="box">
      <h3>LOAD TTC</h3>
      <canvas id="plnLineChart"></canvas>
    </div>

    <div class="box">
      <h3>BBM <img src="asset/Gas Station.png" alt="BBM Logo" class="bbm-logo"></h3>
      <canvas id="bbmChart"></canvas>
    </div>
  </div>
  
  <h1 style="margin-top: 20px;">AVERAGE PUE</h1>
  <div class="box" id="table-dialy">
    <table>
      <thead>
        <tr>
            <th>No</th>
            <th>Tanggal</th>
            <th>kW LV1</th>
            <th>kW LV2</th>
            <th>Total Load PLN</th>
            <th>kW UPS1</th>
            <th>kW UPS2</th>
            <th>kW Rec 1</th>
            <th>kW Rec 2</th>
            <th>kW Rec 3</th>
            <th>kW Rec 4</th>
            <th>Total Load IT Telco</th>
            <th>Facility</th>
            <th>PUE</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script src="frontend/js/sidebar.js"></script>

<script>
  
  // --- API BASE URL CONFIG ---
  function api(endpoint) {
    const site = localStorage.getItem("site"); 
    const baseUrls = {
      teling: "https://api.example.com/teling/",
      paniki: "https://api.example.com/paniki/"
    };
    const baseUrl = baseUrls[site] || "https://api.example.com/default/";
    return baseUrl + endpoint;
  }

  // --- AMBIL SITE DARI LOGIN ---
  const site = localStorage.getItem("site");

  // Update title
  if (site) {
    document.title = `Monitoring Dashboard ${site.charAt(0).toUpperCase() + site.slice(1)}`;
    document.getElementById("page-title").innerText = `MONITORING DASHBOARD ${site.toUpperCase()}`;
  }

  // === PUE Donut Chart ===
  async function updatePUE() {
    try {
      const response = await fetch(api('last-cache-pue'));
      const data = await response.json();
      const usedValue = parseFloat(data.pue);
      const remainingValue = Math.max(0, 4 - usedValue);
      let usedColor = '#008000';
      if (usedValue >= 2) usedColor = '#f44336';
      else if (usedValue >= 1.7) usedColor = '#ff9800';
      pueChart.data.datasets[0].data = [usedValue, remainingValue];
      pueChart.data.datasets[0].backgroundColor = [usedColor, '#e0e0e0'];
      pueChart.update();
    } catch (error) {
      console.error('Gagal mengambil data PUE:', error);
    }
  }

  // === PUE Line Chart ===
  async function fetchDataAndUpdateChartPUE() {
    try {
      const response = await fetch(api('all-pue'));
      const data = await response.json();
      const labels = data.map(item => `${item.jam.toString().padStart(2,'0')}:00`);
      const pueValues = data.map(item => item.pue);
      chart.data.labels = labels;
      chart.data.datasets[0].data = pueValues;
      chart.update();
    } catch (error) {
      console.error('Error fetching data:', error);
    }
  }

  // === PLN Load Line Chart ===
  function fetchDataAndUpdateLineLoad() {
    fetch(api('all-pue'))
      .then(r => r.json())
      .then(data => {
        chartLOAD.data.labels = data.map(i => i.jam);
        chartLOAD.data.datasets[0].data = data.map(i => i.pln);
        chartLOAD.data.datasets[1].data = data.map(i => i.facility);
        chartLOAD.data.datasets[2].data = data.map(i => i.it);
        chartLOAD.update();
      })
      .catch(err => console.error('Gagal memuat data:', err));
  }

  // === BBM Chart ===
  async function updateChartBBM() {
    try {
      const response = await fetch(api('bbm'));
      const data = await response.json();
      bbmChart.data.datasets[0].data = [
        parseFloat(data.tank_harian1), 
        parseFloat(data.tank_bulanan), 
        parseFloat(data.tank_harian2)
      ];
      bbmChart.update();
    } catch(err) {
      console.error('Gagal mengambil data dari API:', err);
    }
  }

  // Sembunyikan NFVI kalau site bukan paniki
  if (site !== "paniki") {
    document.querySelectorAll(".temp-item.nfvi").forEach(el => el.style.display = "none");
  }

  // === Suhu ===
  function updateSuhu() {
    fetch(api('suhu'))
      .then(r=>r.json())
      .then(d=>{
        const suhuData = {
          'Battery RAN': { temp:d.suhu_batran, hum:d.temp_batran },
          'Battery Core': { temp:d.suhu_batcore, hum:d.temp_batcore },
          'RAN': { temp:d.suhu_ran, hum:d.temp_ran },
          'Core': { temp:d.suhu_core, hum:d.temp_core },
          'Interkoneksi': { temp:d.suhu_inter, hum:d.temp_inter },
          'Trafo': { temp:d.suhu_trafo, hum:d.temp_trafo },
          'Genset': { temp:d.suhu_genset, hum:d.temp_genset }
        };
        // NFVI hanya paniki
        if (site === "paniki") {
          suhuData['NFVI'] = { temp:d.suhu_nfvi, hum:d.temp_nfvi };
        }

        document.querySelectorAll('.temp-item .info').forEach(info=>{
          const label = info.querySelector('strong').innerText.replace('\n',' ').trim();
          if(suhuData[label]){
            info.innerHTML = `<strong>${label.replace(' ','<br>')}</strong><br>${suhuData[label].temp.toFixed(1)}°C<br><small>H: ${suhuData[label].hum.toFixed(0)}%</small>`;
          }
        });
      })
      .catch(err=>console.error('Gagal mengambil data suhu:',err));
  }

  // === Table Latest 7 Day ===
  function fetchAndUpdateTable() {
    fetch(api('average-pue'))
      .then(r=>r.json())
      .then(data=>{
        const tbody = document.querySelector('#table-dialy tbody');
        tbody.innerHTML = '';
        data.forEach((item,index)=>{
          const facilityLOAD = parseFloat(item.avg_pln)-parseFloat(item.avg_it_telco);
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${index+1}</td>
            <td>${item.date}</td>
            <td>${parseFloat(item.avg_kw_lvmdp1).toFixed(2)}</td>
            <td>${parseFloat(item.avg_kw_lvmdp2).toFixed(2)}</td>
            <td>${parseFloat(item.avg_pln).toFixed(2)}</td>
            <td>${parseFloat(item.avg_kw_ups1).toFixed(2)}</td>
            <td>${parseFloat(item.avg_kw_ups2).toFixed(2)}</td>
            <td>${parseFloat(item.avg_kw_rec1).toFixed(2)}</td>
            <td>${parseFloat(item.avg_kw_rec2).toFixed(2)}</td>
            <td>${parseFloat(item.avg_kw_rec3).toFixed(2)}</td>
            <td>${parseFloat(item.avg_kw_rec4).toFixed(2)}</td>
            <td>${parseFloat(item.avg_it_telco).toFixed(2)}</td>
            <td>${facilityLOAD.toFixed(2)}</td>
            <td>${parseFloat(item.avg_pue).toFixed(3)}</td>
          `;
          tbody.appendChild(row);
        });
      })
      .catch(err=>console.error('Gagal mengambil data:',err));
  }

  // === Alarm ===
  function cekAlarm(){
    fetch(api('all-pue'))
      .then(r=>r.json())
      .then(data=>{
        data.forEach(item=>{
          if(item.status==1){
            const message = `${item.facility} ${item.device} overload`;
            Swal.fire({icon:'warning',title:'Alarm',text:message});
          }
        });
      }).catch(err=>console.error(err));
  }

  // Interval jalan semua
  setInterval(updatePUE, 1000);
  setInterval(fetchDataAndUpdateChartPUE, 300000);
  setInterval(fetchDataAndUpdateLineLoad, 1000);
  setInterval(updateChartBBM, 1000);
  setInterval(updateSuhu, 5000);
  setInterval(fetchAndUpdateTable, 3600000);
  setInterval(cekAlarm, 5000);

  // Panggil pertama kali
  updatePUE();
  fetchDataAndUpdateChartPUE();
  fetchDataAndUpdateLineLoad();
  updateChartBBM();
  updateSuhu();
  fetchAndUpdateTable();

  
</script>
<script>
  const sidebar = document.getElementById("mySidebar");
  const overlay = document.getElementById("overlay");
  const openSidebar = document.getElementById("openSidebar");
  const closeSidebar = document.getElementById("closeSidebar");

  openSidebar.addEventListener("click", () => {
    sidebar.classList.add("show");
    overlay.classList.add("show");
  });

  closeSidebar.addEventListener("click", () => {
    sidebar.classList.remove("show");
    overlay.classList.remove("show");
  });

  overlay.addEventListener("click", () => {
    sidebar.classList.remove("show");
    overlay.classList.remove("show");
  });
</script>

</body>
</html>
