<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="main.css" />
    <link rel="stylesheet" href="checklist.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <title>FACILITY MONITORING</title>
</head>

<body>
    <main>
        <div id="bodychecklist">
            <h1 id="title">CHECKLIST</h1>
            <div id="bodychecklist-header">
                <div id="bodychecklist-header-seaerch">
                    <input type="date" id="tanggalPicker" name="bulan" class="form-control" />
                    <button class="btn btn-primary" id="btnSearch">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
                <div id="bodychecklist-header-SubMenu">
                    <button class="btn btn-warning" id="kwh">
                        <i class="bi bi-speedometer"></i>
                    </button>
                    <button class="btn btn-warning" id="pue">
                        <i class="bi bi-clipboard2-data"></i>
                    </button>
                    <button class="btn btn-warning" id="gen1">
                        <i class="bi bi-building-gear">1</i>
                    </button>
                    <button class="btn btn-warning" id="gen2">
                        <i class="bi bi-building-gear">2</i>
                    </button>
                </div>

                <div id="bodychecklist-header-extrabutton">
                    <button class="btn btn-success" id="btnCreate">
                        <i class="bi bi-plus-lg"></i>
                    </button>
                    <button class="btn btn-warning" id="btnReport">
                        <i class="bi bi-card-checklist"></i>
                    </button>
                    <button class="btn btn-warning" id="btnExport">
                        <i class="bi bi-download"></i>
                    </button>
                </div>

            </div>

            <!-- Div untuk tabel utama & sub-tabel -->
            <div id="bodychecklist-body" class="badan"></div>
            <div id="bodychecklist-bodyGenset1" class="badan"></div>
            <div id="bodychecklist-bodyGenset2" class="badan"></div>
            <div id="bodychecklist-bodySKWH" class="badan"></div>
        </div>

        <!-- Popup modal -->
        <div id="popupOverlay" class="popup-overlay"></div>
        <div id="popupModal" class="popup-modal">
            <div class="popup-header">
                <h2>Report</h2>
                <button class="popup-close">&times;</button>
            </div>
            <div id="report-selector"></div>
            <div class="popup-body">
                <div>
                    <pre id="isi_report"></pre>
                    <button id="btnCopy">Copy</button>
                </div>
            </div>
        </div>
    </main>

    <script src="js/sidebar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment/min/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment/locale/id.js"></script>
    <script>
        // === Init Hide/Show Body ===
        function hideAllBadan() {
            document.querySelectorAll('.badan').forEach(el => {
                el.classList.add('hide');
            });
        }

        function showBadanById(id) {
            hideAllBadan();
            const el = document.getElementById(id);
            if (el) el.classList.remove('hide');
        }

        // Awal load → tampilkan PUE
        hideAllBadan();
        showBadanById("bodychecklist-body");

        // === Variabel Global ===
        let reportCeklist = [];
        let reportGenset1 = [];
        let reportGenset2 = [];
        let reportKWH = [];

        const ttc = localStorage.getItem('ttc');
        const host = localStorage.getItem('host');
        console.log(host)
        const tanggalInput = document.getElementById('tanggalPicker');
        const btnSearch = document.getElementById('btnSearch');

        // Format date ke YYYY-MM-DD
        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        // === Fungsi generic fetch & render tabel ===
        async function loadChecklistSubTable(apiURL, containerId, addTo) {
            const container = document.getElementById(containerId);
            try {
                const response = await fetch(apiURL);
                if (!response.ok) throw new Error('Gagal ambil data');
                const data = await response.json();

                if (!data || Object.keys(data).length === 0) {
                    container.innerHTML = '<p>Tidak ada data untuk tanggal tersebut.</p>';
                    return;
                }

                const firstKey = Object.keys(data)[0];
                let columns = Object.keys(data[firstKey]);

                // daftar key yang di-skip
                const skipKeys = [
                    "ups1", "ups2", "rec1", "rec2", "rec3", "rec4", "rec5", "rec6", "rec7", "rec8", "rec9",
                    "TrafoCaps", "GensetTotal", "PACTotal", "RECTotal", "UPSTotal",
                    "GensetF", "PACF", "RECF", "UPSF", "Cuaca", "tanggal_formatted", "jam",
                    "Petugas1", "Petugas1NO", "Petugas2", "Petugas2NO", "Petugas3", "Petugas3NO",
                    "Petugas4", "Petugas4NO"
                ];
                columns = columns.filter(col => !skipKeys.includes(col));

                // Build table
                const table = document.createElement('table');
                table.style.width = '100%';
                table.style.borderCollapse = 'collapse';
                table.border = '1';

                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                columns.forEach(col => {
                    const th = document.createElement('th');
                    th.innerText = col.replace(/_/g, ' ').toUpperCase();
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);
                table.appendChild(thead);

                const tbody = document.createElement('tbody');
                let indexROW = 0;
                Object.values(data).forEach(rowData => {
                    const row = document.createElement('tr');
                    columns.forEach(col => {
                        const td = document.createElement('td');
                        td.innerText = rowData[col];
                        row.appendChild(td);
                    });
                    tbody.appendChild(row);
                    indexROW++;
                });
                table.appendChild(tbody);

                container.innerHTML = '';
                container.appendChild(table);
                console.log(indexROW)

                // Simpan ke variabel global
                switch (addTo) {
                    case 'genset1': reportGenset1 = data[indexROW]; console.log('g1'); console.log(reportGenset1); break;
                    case 'genset2': reportGenset2 = data[indexROW]; console.log('g2'); console.log(reportGenset2); break;
                    case 'pue': reportCeklist = data[indexROW]; console.log('reportCeklist'); console.log(reportCeklist); break;
                    case 'kwh': reportKWH = data[indexROW]; console.log('kwh'); console.log(reportKWH); break;
                }

                // ceklistTeling(reportCeklist)

            } catch (error) {
                container.innerHTML = `<p style="color:red;">Error: ${error.message}</p>`;
            }
        }

        // === Load semua tabel berdasarkan tanggal ===
        async function loadAllTables(tanggal) {
            const apiMainURL = `http://${host}/api/${ttc}/checklist/ChecklistPUE?jenis_report=Ceklist&tanggal=${tanggal}`;
            loadChecklistSubTable(apiMainURL, 'bodychecklist-body', "pue");

            const apiG1URL = `http://${host}/api/${ttc}/checklist/Genset1?jenis_report=Genset1&tanggal=${tanggal}`;
            loadChecklistSubTable(apiG1URL, 'bodychecklist-bodyGenset1', "genset1");

            const apiG2URL = `http://${host}/api/${ttc}/checklist/Genset2?jenis_report=Genset2&tanggal=${tanggal}`;
            loadChecklistSubTable(apiG2URL, 'bodychecklist-bodyGenset2', "genset2");

            const jenisReport = "KWH & Suhu";
            const apiKWHURL = `http://${host}/api/${ttc}/checklist/SKWH?jenis_report=${encodeURIComponent(jenisReport)}&tanggal=${tanggal}`;
            loadChecklistSubTable(apiKWHURL, 'bodychecklist-bodySKWH', "kwh");
        }

        // === Inisialisasi tanggal ===
        const today = new Date();
        tanggalInput.value = formatDate(today);
        loadAllTables(tanggalInput.value);

        btnSearch.addEventListener('click', () => {
            if (tanggalInput.value) loadAllTables(tanggalInput.value);
        });
        tanggalInput.addEventListener('change', () => {
            if (tanggalInput.value) loadAllTables(tanggalInput.value);
        });

        // === Navigasi Submenu Button ===
        const subMenuContainer = document.getElementById('bodychecklist-header-SubMenu');
        if (subMenuContainer) {
            subMenuContainer.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', () => {
                    switch (btn.id) {
                        case 'pue': showBadanById("bodychecklist-body"); break;
                        case 'gen1': showBadanById("bodychecklist-bodyGenset1"); break;
                        case 'gen2': showBadanById("bodychecklist-bodyGenset2"); break;
                        case 'kwh': showBadanById("bodychecklist-bodySKWH"); break;
                    }
                });
            });
        }

        // === Export tabel utama (PUE) ===
        document.getElementById('btnExport').addEventListener('click', () => {
            const table = document.querySelector('#bodychecklist-body table');
            if (!table) return alert('Data tabel belum tersedia untuk diexport!');
            const wb = XLSX.utils.table_to_book(table, { sheet: "Checklist" });
            XLSX.writeFile(wb, `checklist_export_${new Date().toISOString().slice(0, 10)}.xlsx`);
        });

        // === Tombol navigasi Create ===
        document.getElementById('btnCreate').addEventListener('click', () => {
            window.location.href = 'checklist/main.html';
        });

        // === Popup modal report ===
        document.addEventListener("DOMContentLoaded", () => {
            const btnReport = document.getElementById('btnReport');
            const popupOverlay = document.getElementById('popupOverlay');
            const popupModal = document.getElementById('popupModal');
            const popupClose = document.querySelector('.popup-close');

            btnReport.addEventListener('click', () => {
                popupOverlay.style.display = 'block';
                popupModal.style.display = 'block';
            });
            popupClose.addEventListener('click', () => {
                popupOverlay.style.display = 'none';
                popupModal.style.display = 'none';
            });
            popupOverlay.addEventListener('click', () => {
                popupOverlay.style.display = 'none';
                popupModal.style.display = 'none';
            });

            // Render tombol report
            const reportSelector = document.getElementById("report-selector");
            if (ttc === 'ttc_teling') {
                reportSelector.innerHTML = `
                <button class="btn btn-warning" id="rep_kwh">KWH & Suhu</button>
                <button class="btn btn-warning" id="rep_checklist">Checklist</button>
                <button class="btn btn-warning" id="rep_genset1">Genset1</button>
                <button class="btn btn-warning" id="rep_genset2">Genset2</button>
            `;
                reportSelector.querySelectorAll("button").forEach(btn => {
                    btn.addEventListener("click", () => {
                        // Reset semua button
                        reportSelector.querySelectorAll("button").forEach(b => {
                            b.classList.remove("btn-primary", "active");
                            if (b.id !== "btnCreate") b.classList.add("btn-warning");
                        });

                        // Set button yang diklik jadi aktif
                        btn.classList.remove("btn-warning");
                        btn.classList.add("btn-primary", "active");

                        // Ambil ID button yang diklik
                        console.log("Button diklik ID:", btn.id);
                        const jenisReport = btn.id;

                        switch (jenisReport) {
                            case 'rep_checklist':
                                ceklistTeling(reportCeklist);
                                break;
                            case 'rep_kwh':
                                kwhTeling(reportKWH);
                                break;
                            case 'rep_genset1':
                                gen1Teling(reportGenset1);
                                break;
                            case 'rep_genset2':
                                gen2Teling(reportGenset2);
                                break;
                            default:
                                break;
                        }
                    });
                });
            }
        });

        function gen1Teling(data) {
            // kumpulin petugas (buang yg null)
            const petugas = [
                data.Petugas1,
                data.Petugas2,
                data.Petugas3,
                data.Petugas4
            ].filter(Boolean); // buang yg null

            // Convert tanki dan tangki ke number agar .toFixed bisa dipakai
            const bulanan = parseFloat(data.tanki_bulanan) || 0;
            const harian = parseFloat(data.tangki_harian) || 0;
            const suhu = parseFloat(data.suhu) || 0;

            // Hitung durasi dalam menit
            let durasiMenit = 0;
            if (data.gen_on && data.gen_off) {
                const onTime = new Date("1970-01-01T" + data.gen_on);
                const offTime = new Date("1970-01-01T" + data.gen_off);
                durasiMenit = Math.round((offTime - onTime) / 60000);
            }

            const isi = `
BERITA ACARA RUNNING GENSET 1

Petugas ME:
${petugas.join(" / ")}

Proses:
${data.proses}

Gedung:
TTC Teling

Hari/Tanggal:
${data.tanggal_formatted}

Running Time (WITA)
Genset On: ${data.gen_on}
Genset Off: ${data.gen_off}
Durasi: ${durasiMenit} Menit

Level BBM (Liter)
Tanki Bulanan Genset 1: ${bulanan.toFixed(0)} L
Tanki Harian Genset 1: ${harian.toFixed(0)} L

Suhu:
${suhu} °C

Hours Matter:
${data.hours_mater}
`;

            document.getElementById("isi_report").textContent = isi;
        }

        function gen2Teling(data) {
            // kumpulin petugas (buang yg null)
            const petugas = [
                data.Petugas1,
                data.Petugas2,
                data.Petugas3,
                data.Petugas4
            ].filter(Boolean);

            // Convert liter dan suhu ke number
            const bulanan = parseFloat(data.liter_bulanan) || 0;
            const harian = parseFloat(data.liter_harian) || 0;
            const suhu = parseFloat(data.suhu) || 0;

            // Hitung durasi dalam menit
            let durasiMenit = 0;
            if (data.gen_on && data.gen_off) {
                const onTime = new Date("1970-01-01T" + data.gen_on);
                const offTime = new Date("1970-01-01T" + data.gen_off);
                durasiMenit = Math.round((offTime - onTime) / 60000);
            }

            const isi = `
BERITA ACARA RUNNING GENSET 2a & 2b

Petugas ME:
${petugas.join(" / ")}

Proses:
${data.proses}

Gedung:
TTC Teling

Hari/Tanggal:
${data.tanggal_formatted}

Running Time (WITA)
Genset On: ${data.gen_on}
Genset Off: ${data.gen_off}
Durasi: ${durasiMenit} Menit

Level BBM (Liter)
Tanki Bulanan Genset 2: ${bulanan.toFixed(0)} L
Tanki Harian Genset 2: ${harian.toFixed(0)} L

Suhu:
${suhu} °C

Hours Matter 1:
${data.hours_mater1 || "-"}

Hours Matter 2:
${data.hours_mater2 || "-"}
`;

            document.getElementById("isi_report").textContent = isi;
        }

        function ceklistTeling(data) {
            function val(x) {
                return (x === null || x === undefined || x === "") ? "-" : x;
            }

            // Handle petugas dari Petugas1..4
            let petugas = [data.Petugas1, data.Petugas2, data.Petugas3, data.Petugas4].filter(Boolean);
            let petugasList = petugas.length > 0 ? petugas.map(p => ` - ${p}`).join("\n") : " - Tidak ada petugas standby";

            let report = `
Site : TTC TELING
ME Standby
${petugasList}


Hari/Tanggal: ${val(data.tanggal_formatted)}
Waktu : ${val(data.jam)} WITA
PLN ON

BP    : ${val(data.bp)}
LBP   : ${val(data.lbp)}
TOTAL : ${val(data.total)}
KVA   : ${val(data.kvar)}

Capacity Trafo ${val(data.TrafoCaps)} KVA
Genset Failed/Total : ${val(data.GensetF)}/ ${val(data.GensetTotal)}
PAC Failled/Total : ${val(data.PACF)}/ ${val(data.PACTotal)}
Rect Failed /Total : ${val(data.RECF)}/ ${val(data.RECTotal)}
UPS Failed/Total : ${val(data.UPSF)}/ ${val(data.UPSTotal)}
---------------------------------------------
Ruang A3 (Lt1)
PAC Type : RCG 60 KW 2 UNIT
RCG 1 : ${val(data.pac1_Status)}
Setpoint : ${val(data.pac1_SetPoint)}
Suhu :  ${val(data.pac1_Suhu)}/${val(data.pac1_Kelembaban)} %
RCG 2 : ${val(data.pac2_Status)}
Setpoint : ${val(data.pac2_SetPoint)}
Suhu :  ${val(data.pac2_Suhu)}/${val(data.pac2_Kelembaban)} %

UPS 1.2.01 ${val(data.ups1_brand)} ${val(data.ups1_type)} KVA
LOAD
- ${val(data.ups1_kw)} A
- ${val(data.ups1_kw)} KW
- ${val(data.ups1_kva)} KVA
- Battery : ${val(data.ups1_battery)}

UPS 1.2.02 ${val(data.ups2_brand)} ${val(data.ups2_type)} KVA
LOAD
- ${val(data.ups2_kw)} A
- ${val(data.ups2_kw)} KW
- ${val(data.ups2_kva)} KVA
- Battery : ${val(data.ups2_battery)}

Update Rectifier :
${[...Array(9)].map((_, idx) => {
                let r = idx + 1;
                return `Rectifier#1.2.${r}
Load Curr : ${val(data[`rec${r}_TotalLoad`])} A
Occupancy : ${val(data[`rec${r}_Ocupanccy`])} %`;
            }).join("\n")}

Suhu Ruangan : ${val(data.core)} °C
---------------------------------------------
Ruang Genset
LVMDP 1
R : ${val(data.lvmdp1_r)} A
S : ${val(data.lvmdp1_s)} A
T : ${val(data.lvmdp1_t)} A
KW : ${val(data.lvmdp1_load)}
KVA : ${val(data.lvmdp1_kva)}
CosQ : ${val(data.faktor_daya)}

LVMDP 2
R : ${val(data.lvmdp2_r)} A
S : ${val(data.lvmdp2_s)} A
T : ${val(data.lvmdp2_t)} A
KW : ${val(data.lvmdp2_load)}
KVA : ${val(data.lvmdp2_kva)}

Total Load PLN : ${val(data.total_load_pln)} A
Occupancy PLN : ${val(data.occupancy_pln)}

Suhu Ruangan: ${val(data.genset)} °C
---------------------------------------------
AC Portable
Lantai 1 : - 
Lantai 2 : - 
Kondisi Terakhir Rehersal Genset
Genset 1 : ${val(data.tanggal_formatted)}
Genset 2 : ${val(data.tanggal_formatted)}
`;

            document.getElementById("isi_report").textContent = report;
        }

        function kwhTeling(data) {
            // kumpulin petugas (ada yg bisa null)
            const petugas = [
                data.Petugas1,
                data.Petugas2,
                data.Petugas3,
                data.Petugas4
            ].filter(Boolean); // buang yg null

            const isi = `
Report Kwh dan Suhu TTC Teling
Hari/Tanggal: ${data.tanggal_formatted}
Pukul: ${data.jam} WITA

STATUS
PLN    : On
Genset : standby

KWH
BP    : ${data.bp}
LBP   : ${data.lbp}
TOTAL : ${data.total}
KVA   : ${data.kvar}

Suhu
R. Trafo         : ${data.RTrafo}
R. Genset        : ${data.RGenset}
R. Ran           : ${data.RRan}
R. Control       : ${data.RKontrol}
R. Battery       : ${data.RBattery}
R. Transmissi    : ${data.RTransmissi}
R. Core          : ${data.RCore}

ME    : 
${petugas.map(nama => " - " + nama).join("\n")}

Cuaca : Mendung
Power dan suhu ruangan aman.
  `;

            document.getElementById("isi_report").textContent = isi;
        }

        function ceklistPaniki(data) {
            function val(x) {
                return (x === null || x === undefined || x === "") ? "-" : x;
            }

            // Handle petugas dari Petugas1..4
            let petugas = [data.Petugas1, data.Petugas2, data.Petugas3, data.Petugas4].filter(Boolean);
            let petugasList = petugas.length > 0 ? petugas.map(p => ` - ${p}`).join("\n") : " - Tidak ada petugas standby";

            let report = `
Site : TTC TELING
ME Standby
${petugasList}


Hari/Tanggal: ${val(data.tanggal_formatted)}
Waktu : ${val(data.jam)} WITA
PLN ON

BP    : ${val(data.bp)}
LBP   : ${val(data.lbp)}
TOTAL : ${val(data.total)}
KVA   : ${val(data.kvar)}

Capacity Trafo ${val(data.TrafoCaps)} KVA
Genset Failed/Total : ${val(data.GensetF)}/ ${val(data.GensetTotal)}
PAC Failled/Total : ${val(data.PACF)}/ ${val(data.PACTotal)}
Rect Failed /Total : ${val(data.RECF)}/ ${val(data.RECTotal)}
UPS Failed/Total : ${val(data.UPSF)}/ ${val(data.UPSTotal)}
---------------------------------------------
Ruang A3 (Lt1)
PAC Type : RCG 60 KW 2 UNIT
RCG 1 : ${val(data.pac1_Status)}
Setpoint : ${val(data.pac1_SetPoint)}
Suhu :  ${val(data.pac1_Suhu)}/${val(data.pac1_Kelembaban)} %
RCG 2 : ${val(data.pac2_Status)}
Setpoint : ${val(data.pac2_SetPoint)}
Suhu :  ${val(data.pac2_Suhu)}/${val(data.pac2_Kelembaban)} %

UPS 1.2.01 ${val(data.ups1_brand)} ${val(data.ups1_type)} KVA
LOAD
- ${val(data.ups1_kw)} A
- ${val(data.ups1_kw)} KW
- ${val(data.ups1_kva)} KVA
- Battery : ${val(data.ups1_battery)}

UPS 1.2.02 ${val(data.ups2_brand)} ${val(data.ups2_type)} KVA
LOAD
- ${val(data.ups2_kw)} A
- ${val(data.ups2_kw)} KW
- ${val(data.ups2_kva)} KVA
- Battery : ${val(data.ups2_battery)}

Update Rectifier :
${[...Array(9)].map((_, idx) => {
                let r = idx + 1;
                return `Rectifier#1.2.${r}
Load Curr : ${val(data[`rec${r}_TotalLoad`])} A
Occupancy : ${val(data[`rec${r}_Ocupanccy`])} %`;
            }).join("\n")}

Suhu Ruangan : ${val(data.core)} °C
---------------------------------------------
Ruang Genset
LVMDP 1
R : ${val(data.lvmdp1_r)} A
S : ${val(data.lvmdp1_s)} A
T : ${val(data.lvmdp1_t)} A
KW : ${val(data.lvmdp1_load)}
KVA : ${val(data.lvmdp1_kva)}
CosQ : ${val(data.faktor_daya)}

LVMDP 2
R : ${val(data.lvmdp2_r)} A
S : ${val(data.lvmdp2_s)} A
T : ${val(data.lvmdp2_t)} A
KW : ${val(data.lvmdp2_load)}
KVA : ${val(data.lvmdp2_kva)}

Total Load PLN : ${val(data.total_load_pln)} A
Occupancy PLN : ${val(data.occupancy_pln)}

Suhu Ruangan: ${val(data.genset)} °C
---------------------------------------------
AC Portable
Lantai 1 : - 
Lantai 2 : - 
Kondisi Terakhir Rehersal Genset
Genset 1 : ${val(data.tanggal_formatted)}
Genset 2 : ${val(data.tanggal_formatted)}
`;

            document.getElementById("isi_report").textContent = report;
        }



        const btnCopy = document.getElementById("btnCopy");
        const isiReport = document.getElementById("isi_report");

        // Fungsi copy
        function copyReport() {
            // Gunakan Clipboard API
            navigator.clipboard.writeText(isiReport.textContent)
                .then(() => {
                    Swal.fire({ toast: true, position: "top-end", icon: "success", title: "Saved!", showConfirmButton: false, timer: 1500 });
                })
                .catch(err => {
                    console.error("Gagal copy: ", err);
                });
        }

        // Pasang event listener ke tombol
        btnCopy.addEventListener("click", copyReport);
    </script>

</body>

</html>