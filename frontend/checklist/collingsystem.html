<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="main.css" />
    <title>CHECKLIST</title>
</head>

<body>
    <main>
        <img src="../asset/logo-telkomsel-baru.DYhv_uL8_1T5nit-removebg-preview.png" alt="Logo Telkomsel" class="logo">
        <h1>Form Checklist</h1>
        <div id="body" class="bodyCOOLING">
            <form id="myForm" class="form_it">

            </form>
        </div>
    </main>


    <!-- `http://${host}/api/${ttc}/checklist/list_dp_tables/user_bio/jabatan/ME`
`http://${host}/api/${ttc}/data_potensi/generate_columns/${item}`
`http://${host}/api/${ttc}/checklist/tableReportList` -->
    <script src="loder.js"></script>
    <script>
        const ttc = localStorage.getItem('ttc');
        const host = localStorage.getItem('host');
        const jenisReport = sessionStorage.getItem('jenisReport');
        console.log(host);


        const data_perangkat = {};

        // Ambil daftar tableReportList
        fetch(`http://${host}/api/${ttc}/checklist/tableReportList`)
            .then(res => res.json())
            .then(async data => {
                const form = document.getElementById("myForm");
                const suhuItems = data.coling_system;

                for (let i = 0; i < suhuItems.length; i++) {
                    const item = suhuItems[i];

                    // Buat div parent
                    const div = document.createElement("div");
                    div.id = item;
                    div.className = "cooling";

                    const heading = document.createElement("h2");
                    heading.textContent = formatLabel(item);
                    div.appendChild(heading);

                    form.appendChild(div);

                    // --- FETCH DETAIL DATA PERANGKAT DAN SIMPAN KE data_perangkat ---
                    try {
                        const response = await fetch(`http://${host}/api/ttc_teling/checklist/${item}/id`);
                        const detailData = await response.json();

                        // Simpan ke global object
                        data_perangkat[item] = detailData;

                        // Console log untuk preview
                        console.log(`Data perangkat [${item}]:`, data_perangkat[item]);
                    } catch (err) {
                        console.error(`Gagal fetch data perangkat [${item}]:`, err);
                    }

                    // Tunggu generateInputRow selesai
                    await generateInputRow(item);

                    // Delay 1 detik sebelum item berikutnya
                    await new Promise(resolve => setTimeout(resolve, 3000));
                }

                // Tambah tombol kirim
                appendButton("myForm", "Kirim Data", () => submitFormDataNested("myForm"));
            })
            .catch(err => console.error("Error:", err));






        function getInputType(dataType) {
            // Mapping tipe data dari API ke tipe input HTML
            switch (dataType) {
                case "date":
                    return "date";
                case "time":
                    return "time";
                case "datetime":
                    return "datetime-local";
                case "int":
                    return "number";
                case "float":
                    return "number"; // step=any nanti ditambah di generateInputRow
                case "varchar":
                default:
                    return "text";
            }
        }

        function formatLabel(text) {
            // Ubah snake_case atau nama kolom jadi Kapital Awal Tiap Kata
            return text
                .replace(/_/g, " ")
                .replace(/\b\w/g, c => c.toUpperCase());
        }

        async function generateInputRow(idParent) {
            try {
                const form = document.getElementById(idParent);

                // Ambil struktur kolom
                const resCols = await fetch(`http://${host}/api/${ttc}/data_potensi/generate_columns/${idParent}`);
                const columns = await resCols.json();

                // Ambil data petugas ME
                const resUsers = await fetch(`http://${host}/api/${ttc}/checklist/list_dp_tables/user_bio/jabatan/ME`);
                const users = await resUsers.json();

                columns.forEach(col => {
                    if (["no_report", "status", "id", "liter_harian", "liter_bulanan", "id_report_suhu", "id_report_kwh", "date_time", "dokumentasi", "indikator", "id_report_lvmdp2", "id_report_lvmdp1", "dateTime", "Time", "date", "Date"].includes(col.COLUMN_NAME)) return;

                    const label = document.createElement("label");
                    label.setAttribute("for", col.COLUMN_NAME);
                    label.className = "form-label";
                    label.textContent = formatLabel(col.COLUMN_NAME);

                    let inputElement;

                    // --- SELECT PETUGAS ME ---
                    if (["petugasME", "petugasME2", "petugasME3", "petugasME4"].includes(col.COLUMN_NAME)) {
                        inputElement = document.createElement("select");
                        inputElement.name = col.COLUMN_NAME;
                        inputElement.id = col.COLUMN_NAME;
                        inputElement.className = "form-select";

                        const defaultOpt = document.createElement("option");
                        defaultOpt.value = "";
                        defaultOpt.textContent = "-- Pilih Petugas --";
                        inputElement.appendChild(defaultOpt);

                        users.forEach(user => {
                            const opt = document.createElement("option");
                            opt.value = user.id;
                            opt.textContent = user.Nama;

                            // --- set selected dari data_perangkat ---
                            if (data_perangkat[idParent] && data_perangkat[idParent][col.COLUMN_NAME] == user.id) {
                                opt.selected = true;
                            }

                            inputElement.appendChild(opt);
                        });

                        // --- SELECT PROSSES ---
                    } else if (col.COLUMN_NAME === "prosses") {
                        inputElement = document.createElement("select");
                        inputElement.name = col.COLUMN_NAME;
                        inputElement.id = col.COLUMN_NAME;
                        inputElement.className = "form-select";

                        const options = ["PLN Off", "Auto Reharsal", "Manual Reharsal"];
                        const defaultOpt = document.createElement("option");
                        defaultOpt.value = "";
                        defaultOpt.textContent = "-- Pilih Jenis Report --";
                        inputElement.appendChild(defaultOpt);

                        options.forEach(optValue => {
                            const opt = document.createElement("option");
                            opt.value = optValue;
                            opt.textContent = optValue;

                            // --- set selected dari data_perangkat ---
                            if (data_perangkat[idParent] && data_perangkat[idParent][col.COLUMN_NAME] == optValue) {
                                opt.selected = true;
                            }

                            inputElement.appendChild(opt);
                        });

                        // --- INPUT BIASA ---
                    } else {
                        inputElement = document.createElement("input");
                        inputElement.type = getInputType(col.DATA_TYPE);
                        inputElement.name = col.COLUMN_NAME;
                        inputElement.id = col.COLUMN_NAME;
                        inputElement.className = "form-control";

                        if (col.DATA_TYPE === "float") inputElement.step = "any";

                        // --- set value dari data_perangkat ---
                        if (data_perangkat[idParent] && data_perangkat[idParent][col.COLUMN_NAME] !== undefined) {
                            inputElement.value = data_perangkat[idParent][col.COLUMN_NAME];
                        }
                    }

                    const div = document.createElement("div");
                    div.className = "mb-3";
                    div.appendChild(label);
                    div.appendChild(inputElement);

                    form.appendChild(div);
                });

            } catch (err) {
                console.error("Error:", err);
            }
        }




        function appendButton(idParent, buttonText = "Submit", onClickHandler = null) {
            const form = document.getElementById(idParent);
            if (!form) {
                console.error("Form not found:", idParent);
                return;
            }

            const btn = document.createElement("button");
            btn.type = "button"; // bisa diubah jadi "submit" kalau mau submit form biasa
            btn.textContent = buttonText;
            btn.className = "btn btn-primary w-100"; // styling Bootstrap, sesuaikan kalau pakai CSS sendiri

            if (typeof onClickHandler === "function") {
                btn.addEventListener("click", onClickHandler);
            }

            form.appendChild(btn);  // <<< ini yang kurang
        }


        function submitFormDataNested(formId) {
            const form = document.getElementById(formId);
            if (!form) return console.error("Form not found:", formId);

            const formData = {};

            // Ambil semua div langsung di dalam form
            const sections = form.querySelectorAll(":scope > div");

            sections.forEach(section => {
                const sectionId = section.id;
                if (!sectionId) return;

                const sectionData = {};
                // Ambil semua input/select/textarea dalam section itu
                section.querySelectorAll("input, select, textarea").forEach(el => {
                    if (!el.name) return;
                    sectionData[el.name] = el.value;
                });

                formData[sectionId] = sectionData;
            });

            console.log("Nested Form Data:", formData);

            // Kirim ke API
            fetch(`http://${host}/api/${ttc}/checklist/sendInfoReport`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(formData)
            })
                .then(res => res.json())
                .then(response => {
                    console.log("Response from API:", response);

                    // matiin loader pas request selesai
                    document.getElementById("loader").style.display = "none";

                    // update status langsung
                    return fetch(`http://${host}/api/ttc_teling/checklist/updateStatus`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({})
                    });
                })
                .then(res => res.json())
                .then(data => {
                    console.log("Update status response:", data);
                    window.location.href = "../checklist.html";
                })
                .catch(err => {
                    console.error("Error fetch:", err);
                    alert("Terjadi kesalahan saat menghubungi server.");
                    document.getElementById("loader").style.display = "none";
                });
        }





    </script>
</body>

</html>